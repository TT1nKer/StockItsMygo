# 股票数据库使用指南

## 数据库概况

- **股票总数**: 2,156只 NASDAQ股票
- **数据库大小**: 1.47 GB
- **价格数据覆盖率**: 100% (2,156/2,156)
- **时间范围**: 完整历史数据（每只股票通常10-30年）
- **数据粒度**: 日线级别
- **数据库位置**: `d:/strategy=Z/db/stock.db`

## 包含的数据类型

### 1. 价格历史数据 (全部2,156只股票)
- 每日OHLCV数据（开盘价、最高价、最低价、收盘价、成交量）
- 完整的历史范围（Yahoo Finance可获得的最大数据）
- 包含分红和拆股信息

### 2. 分析师数据 (3只股票: AAPL, GOOGL, MSFT)
- 分析师评级（升级/降级）
- 目标价格（共识数据）
- 机构持仓
- 内部交易

### 3. 技术指标 (3只股票: AAPL, MSFT, NVDA)
- 移动平均线（MA5, MA20, MA60）
- RSI（相对强弱指标）
- MACD（异同移动平均线）
- 布林带

### 4. 期权数据 (2只股票: AAPL, MSFT)
- 期权链（看涨期权/看跌期权）
- 希腊字母（delta, gamma, theta, vega）
- 隐含波动率

---

## 如何使用数据库

### 基础设置

```python
from db.api import StockDB

# 初始化数据库连接
db = StockDB()
```

### 1. 获取股票列表

```python
# 获取所有股票
all_stocks = db.get_stock_list()
print(f"股票总数: {len(all_stocks)}")  # 2156

# 按市场类别筛选
nasdaq_global = db.get_stock_list(market_category='Q')  # NASDAQ全球精选市场
nasdaq_capital = db.get_stock_list(market_category='G')  # NASDAQ资本市场
```

### 2. 查询价格历史

```python
# 获取股票的完整价格历史
df = db.get_price_history('AAPL')
print(df.head())
# 列: date, open, high, low, close, volume, dividends, stock_splits

# 查询特定日期范围的价格
df = db.get_price_history('AAPL',
                           start_date='2024-01-01',
                           end_date='2024-12-31')

# 获取最新价格
latest = db.get_latest_price('AAPL')
print(f"最新收盘价: {latest['close']}")
print(f"最新日期: {latest['date']}")
```

### 3. 查询分红和拆股

```python
# 获取分红历史
dividends = db.get_dividends('AAPL')
print(dividends)

# 获取拆股历史
splits = db.get_splits('AAPL')
print(splits)
```

### 4. 查询技术指标

```python
# 获取技术指标（仅AAPL, MSFT, NVDA可用）
indicators = db.get_technical_indicators('AAPL')
print(indicators.head())
# 列: date, ma5, ma20, ma60, rsi, macd, macd_signal, macd_hist,
#     bb_upper, bb_middle, bb_lower

# 查询特定日期范围的指标
indicators = db.get_technical_indicators('AAPL',
                                          start_date='2024-01-01',
                                          end_date='2024-12-31')
```

### 5. 查询分析师数据（仅AAPL, GOOGL, MSFT）

```python
# 获取分析师评级
ratings = db.get_analyst_ratings('AAPL')
print(ratings)

# 获取价格目标
targets = db.get_price_targets('AAPL')
print(f"目标价格: {targets['target_price'].iloc[0]}")
print(f"分析师数量: {targets['number_of_analysts'].iloc[0]}")

# 获取机构持仓
institutions = db.get_institutional_holders('AAPL')
print(institutions)

# 获取内部交易
insider = db.get_insider_transactions('AAPL')
print(insider)
```

### 6. 查询期权数据（仅AAPL, MSFT）

```python
# 获取股票的所有期权
options = db.get_options('AAPL')
print(options)

# 获取特定到期日的期权
options = db.get_options('AAPL', expiration_date='2024-12-20')
```

---

## 下载新数据

### 更新价格历史

```python
# 更新单只股票
db.download_price_history('AAPL', period='max')

# 批量更新（并发下载）
stocks = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA']
db.batch_download_prices(stocks, workers=5)

# 强制重新下载（忽略增量更新）
db.download_price_history('AAPL', force_update=True)
```

### 下载股票的所有数据类型

```python
# 下载股票的所有可用数据
db.download_all_data('AAPL')

# 包括：
# - 价格历史
# - 分红
# - 拆股
# - 分析师评级
# - 价格目标
# - 机构持仓
# - 内部交易
# - 期权数据
# - 技术指标
```

### 检查更新状态

```python
# 检查哪些需要更新
status = db.get_update_status()
print(status)

# 检查股票是否需要更新（基于频率）
needs_update = db.needs_update('AAPL', 'price_history', frequency='daily')
print(f"需要更新: {needs_update}")
```

---

## 示例：股票分析

### 示例1：查找表现最好的股票

```python
from db.api import StockDB
import pandas as pd

db = StockDB()
all_stocks = db.get_stock_list()

results = []
for symbol in all_stocks[:50]:  # 前50只股票
    df = db.get_price_history(symbol, start_date='2024-01-01')
    if len(df) > 0:
        start_price = df.iloc[0]['close']
        end_price = df.iloc[-1]['close']
        pct_change = ((end_price - start_price) / start_price) * 100
        results.append({
            'symbol': symbol,
            '起始价': start_price,
            '结束价': end_price,
            '涨跌幅%': pct_change
        })

# 按表现排序
results_df = pd.DataFrame(results)
top_10 = results_df.nlargest(10, '涨跌幅%')
print(top_10)
```

### 示例2：使用现有的判断函数

```python
from script.judgeV0 import judge

# 使用数据库模式（更快，无需API调用）
result = judge('AAPL', use_db=True)
print(result)  # BUY, SELL, 或 HOLD

# 传统模式（实时API调用）
result = judge('AAPL', use_db=False)
```

### 示例3：计算自定义指标

```python
from db.api import StockDB
import pandas as pd

db = StockDB()
df = db.get_price_history('AAPL', start_date='2023-01-01')

# 计算20日移动平均线
df['ma20'] = df['close'].rolling(window=20).mean()

# 计算每日收益率
df['returns'] = df['close'].pct_change()

# 计算波动率（30日滚动标准差）
df['volatility'] = df['returns'].rolling(window=30).std()

print(df[['date', 'close', 'ma20', 'returns', 'volatility']].tail())
```

### 示例4：寻找突破股票

```python
from db.api import StockDB

db = StockDB()
all_stocks = db.get_stock_list()

breakout_stocks = []

for symbol in all_stocks:
    df = db.get_price_history(symbol, start_date='2024-11-01')
    if len(df) > 20:
        # 计算20日均线
        df['ma20'] = df['close'].rolling(window=20).mean()

        # 最新价格突破20日均线
        latest = df.iloc[-1]
        prev = df.iloc[-2]

        if prev['close'] < prev['ma20'] and latest['close'] > latest['ma20']:
            breakout_stocks.append({
                'symbol': symbol,
                'price': latest['close'],
                'ma20': latest['ma20'],
                'volume': latest['volume']
            })

print(f"找到 {len(breakout_stocks)} 只突破股票")
for stock in breakout_stocks[:10]:  # 显示前10只
    print(f"{stock['symbol']}: ${stock['price']:.2f} (均线: ${stock['ma20']:.2f})")
```

### 示例5：计算投资组合收益

```python
from db.api import StockDB
import pandas as pd

db = StockDB()

# 定义投资组合
portfolio = {
    'AAPL': 10,   # 10股苹果
    'MSFT': 15,   # 15股微软
    'GOOGL': 5,   # 5股谷歌
    'AMZN': 8,    # 8股亚马逊
    'NVDA': 12    # 12股英伟达
}

# 计算投资组合价值
start_date = '2024-01-01'
end_date = '2024-12-31'

portfolio_value = []

for symbol, shares in portfolio.items():
    df = db.get_price_history(symbol, start_date=start_date, end_date=end_date)
    df['value'] = df['close'] * shares
    df['symbol'] = symbol
    portfolio_value.append(df[['date', 'symbol', 'value']])

# 合并所有股票
all_data = pd.concat(portfolio_value)

# 按日期计算总价值
daily_total = all_data.groupby('date')['value'].sum().reset_index()
daily_total.columns = ['date', 'total_value']

print("投资组合总价值：")
print(daily_total.tail())

# 计算总收益
initial_value = daily_total.iloc[0]['total_value']
final_value = daily_total.iloc[-1]['total_value']
total_return = ((final_value - initial_value) / initial_value) * 100

print(f"\n初始价值: ${initial_value:,.2f}")
print(f"最终价值: ${final_value:,.2f}")
print(f"总收益率: {total_return:.2f}%")
```

---

## 数据库统计

```python
# 运行覆盖率检查
import subprocess
subprocess.run(['python', 'check_data_coverage.py'])

# 或者在Python中
from db.api import StockDB
db = StockDB()
status = db.get_update_status()
print(status.groupby('data_type').size())
```

---

## 性能优化提示

1. **使用日期过滤器**: 只查询需要的日期范围
   ```python
   df = db.get_price_history('AAPL', start_date='2024-01-01')
   ```

2. **批量操作**: 在循环中处理多只股票
   ```python
   for symbol in stock_list:
       df = db.get_price_history(symbol)
       # 你的分析代码
   ```

3. **增量更新**: 数据库自动跟踪上次更新日期
   ```python
   db.download_price_history('AAPL')  # 只下载新数据
   ```

4. **关闭连接**: 不需要（自动管理），但你可以：
   ```python
   # 连接在每次查询后自动关闭
   ```

---

## 数据新鲜度

- **最后更新**: 2025-12-26
- **更新频率**: 根据需要运行下载脚本
- **增量更新**: 支持（只下载新数据）

---

## 相关文件

- **数据库**: `d:/strategy=Z/db/stock.db` (1.47 GB)
- **API接口**: `d:/strategy=Z/db/api.py` (StockDB类)
- **数据库结构**: `d:/strategy=Z/db/init_db.py`
- **股票判断**: `d:/strategy=Z/script/judgeV0.py`
- **覆盖率检查**: `d:/strategy=Z/check_data_coverage.py`
- **下载所有股票**: `d:/strategy=Z/download_all_stocks.py`
- **重试失败下载**: `d:/strategy=Z/retry_failed_downloads.py`

---

## 常见问题

### Q: 如何查看某只股票有多少历史数据？
```python
df = db.get_price_history('AAPL')
print(f"数据条数: {len(df)}")
print(f"起始日期: {df.iloc[0]['date']}")
print(f"结束日期: {df.iloc[-1]['date']}")
```

### Q: 如何找出成交量最大的股票？
```python
all_stocks = db.get_stock_list()
volumes = []

for symbol in all_stocks[:100]:  # 检查前100只
    latest = db.get_latest_price(symbol)
    if latest:
        volumes.append({'symbol': symbol, 'volume': latest['volume']})

volumes_df = pd.DataFrame(volumes)
top_volume = volumes_df.nlargest(10, 'volume')
print(top_volume)
```

### Q: 如何导出数据到CSV？
```python
df = db.get_price_history('AAPL')
df.to_csv('AAPL_history.csv', index=False)
```

### Q: 数据库占用空间太大怎么办？
目前1.47 GB包含2156只股票的完整历史数据。如果需要缩减：
1. 只保留需要的股票
2. 只保留最近几年的数据
3. 删除不常用的数据类型（期权、技术指标等）

### Q: 如何添加自己计算的指标到数据库？
数据库schema支持扩展。你可以：
1. 在Python中计算指标后保存为DataFrame
2. 或者修改 `init_db.py` 添加新表
3. 在 `api.py` 中添加保存方法

---

## 下一步

现在你可以：
1. ✅ 查询任何股票的历史数据
2. ✅ 使用judge函数快速判断买卖
3. ✅ 编写自己的量化策略
4. ✅ 回测交易策略
5. ✅ 寻找投资机会

需要帮助编写具体的策略吗？比如：
- 动量策略
- 均线交叉策略
- 波动率突破策略
- 价值投资筛选
- 技术形态识别
